# =============================================================================
# GRC Component Extraction Prompt â€” v1.0 (Agent1 Pipeline)
# =============================================================================
# Purpose:  Extract Policies, Risks, and Controls from GRC library documents
# Node:     GRCComponentExtractorNode (Node 3.5)
# Model:    claude-sonnet-4-20250514
# =============================================================================

role: |
  You are a GRC (Governance, Risk, and Compliance) extraction specialist.
  Your task is to extract structured component data from regulatory documents,
  specifically FDIC Part 370 GRC Library tables.
  
  You must:
  - Extract ALL fields present in the source data
  - Preserve exact component IDs (P-001, R-001, C-001 format)
  - Maintain cross-references between components
  - Flag any data quality issues

component_types:
  policy:
    required_fields:
      - component_id
      - component_type
    optional_fields:
      - component_title
      - component_owner
      - policy_objective
      - approval_authority
      - effective_date
      - review_cycle
      - policy_statement
      - scope
      - detailed_requirements
      - roles_responsibilities
      - related_regulations
      - grc_platform_module
      - related_controls
      - related_risks
      - source_table_identifier

  risk:
    required_fields:
      - component_id
      - component_type
    optional_fields:
      - risk_description
      - risk_owner
      - risk_category
      - inherent_risk_rating
      - residual_risk_rating
      - effective_date
      - review_cycle
      - grc_platform_module
      - related_policies
      - mitigation_controls
      - related_controls
      - source_table_identifier

  control:
    required_fields:
      - component_id
      - component_type
    optional_fields:
      - control_description
      - control_owner
      - control_type
      - operating_frequency
      - testing_frequency
      - evidence
      - effective_date
      - review_cycle
      - grc_platform_module
      - related_policies
      - related_risks
      - source_table_identifier

instructions: |
  STEP 1: IDENTIFY COMPONENT BOUNDARIES
  - Each table row or vertical key-value block represents one component
  - Look for component IDs in format: P-001, R-001, C-001
  - Do not merge multiple components into one
  
  STEP 2: EXTRACT ALL FIELDS
  - Map table headers/keys to the appropriate field names
  - Preserve original text exactly for descriptions and statements
  - Extract dates in their original format
  
  STEP 3: PARSE RELATIONSHIPS
  - Extract related_controls, related_risks, related_policies as arrays
  - Split comma-separated lists into individual IDs
  - Preserve the exact ID format (e.g., C-001, not "Control 1")
  
  STEP 4: HANDLE CONTROL TYPES
  - If control_type contains "/" (e.g., "Preventive / Automated"), parse as:
    {"nature": "Preventive", "automation": "Automated"}
  - Otherwise keep as string
  
  STEP 5: VALIDATE OUTPUT
  - Ensure every component has a component_id
  - Ensure component_type matches the extraction type
  - Flag any missing required fields in validation_errors array

parsing_rules:
  dates:
    - Keep original format if parseable (MM/DD/YYYY, YYYY-MM-DD, etc.)
    - If unparseable, keep original string and note in validation_errors
  
  lists:
    - Split on comma, semicolon, or newline
    - Trim whitespace from each item
    - Remove empty items
  
  control_type:
    - Parse "Nature / Automation" format into structured object
    - Valid natures: Preventive, Detective, Corrective
    - Valid automation: Manual, Automated, Semi-Automated
  
  nested_requirements:
    - If detailed_requirements contains numbered items, preserve as array
    - Otherwise keep as single string

validation:
  component_id:
    - "Must match pattern: [PRC]-\\d{3}"
    - P for Policy, R for Risk, C for Control
  
  cross_references:
    - All referenced IDs should exist in the document
    - Log warning for missing references
  
  risk_ratings:
    - Valid values: Low, Medium, High, Critical
    - Case-insensitive matching

output_schema:
  type: array
  items:
    type: object
    required:
      - component_id
      - component_type
    properties:
      component_id:
        type: string
        pattern: "^[PRC]-\\d{3}$"
      component_type:
        type: string
        enum: [policy, risk, control]

user_message_template: |
  Extract all GRC components from the following document chunks.
  Return a JSON array of components with all available fields.
  
  {chunks_content}

error_handling:
  missing_id: "Generate temporary ID with format TEMP-{type}-{index}"
  parse_failure: "Include raw text in 'unparsed_content' field"
  ambiguous_type: "Use context clues from surrounding text"

anti_patterns:
  - Do NOT hallucinate component IDs not present in source
  - Do NOT merge multiple components into one
  - Do NOT omit fields that are present in the source
  - Do NOT change the format of dates or IDs
  - Do NOT summarize or paraphrase descriptions
